

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Streaming Processing &mdash; Scipion 2.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../static/documentation_options.js"></script>
        <script type="text/javascript" src="../../static/jquery.js"></script>
        <script type="text/javascript" src="../../static/underscore.js"></script>
        <script type="text/javascript" src="../../static/doctools.js"></script>
        <script type="text/javascript" src="../../static/language_data.js"></script>
    
    <script type="text/javascript" src="../../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="pyworkflow package" href="../../api/pyworkflow.html" />
    <link rel="prev" title="Tutorial" href="facilities-tutorial.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/how-to-install.html">How to install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/host-configuration.html">Host configuration</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#graphical-interface-manuals">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="facilities-tutorial.html">Tutorial</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Streaming Processing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#for-facilities">For facilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">Streaming processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#launching-workflows">Launching workflows</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#static-templates">Static templates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dynamic-templates">Dynamic templates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-scipion-s-api">Using Scipion’s API</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/pyworkflow.html">pyworkflow package</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Streaming Processing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../sources/docs/facilities/facilities.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="figure">
<a class="reference internal image-reference" href="../../images/scipion_logo.gif"><img alt="scipion logo" src="../../images/scipion_logo.gif" style="width: 250px;" /></a>
</div>
<div class="section" id="streaming-processing">
<span id="facilities"></span><h1>Streaming Processing<a class="headerlink" href="#streaming-processing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="for-facilities">
<h2>For facilities<a class="headerlink" href="#for-facilities" title="Permalink to this headline">¶</a></h2>
<p>Currently, scipion is being used every day in several facilities in Europe, US,
Canada, Israel and Australia. If you are running a Cryo EM facility and want more
info, please <a class="reference external" href="mailto:scipion&#37;&#52;&#48;i2pc&#46;com">contatct us</a>. We will be happy to help you run
Scipion there. Also, we have a <a class="reference external" href="https://scipion.slack.com">Slack</a> framework to
maintain a direct communication channel.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="docs/facilities/docs/images/facilities_map.png"><img alt="facilities map" src="docs/facilities/docs/images/facilities_map.png" style="width: 900px;" /></a>
</div>
</div>
<div class="section" id="id1">
<h2>Streaming processing<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Scipion is able to process data in streaming, i.e, at the same time movies
(or micrographs) are coming from the microscope PC. It can also be called
on-the-fly processing. This allows to overlap computing time with the
acquisition (reducing computational needs) and also to detect problems at
early stages. This idea is implemented in different labs mainly by using
custom-made scripts, but also it can be implemented using templates in a very
easy way. The advantage of our Scipion solution is that you have
the usual flexibility to choose what operations to do and the traceability to
re-do some of the steps later. It is basically the same Scipion interface with
one key change: the output is produced as soon as the first element is
available, and it is later updated with new output elements. This allows
concatenating several operations before the first one is completed.</p>
<p>On top of that, we have added the concept of monitors, the special protocols
that constantly check how the execution of other protocols is going. We have
developed several GUIs that are refreshed periodically and produce a graphical
summary (e.g, CTF defocus values, system load etc). A summary is also generated
in HTML format that can be easily copied to a public website to provide access
for external users.</p>
<p>To see the HTML summary report from Scipion you must launch the <em>Summary monitor</em>
protocol (or select it if it is already in the workflow), click on the
<em>Analyze results</em> button (down-right) and, then, click on the “Open HTML report”
button. A browser will show you something
like <a class="reference external" href="http://scipion.cnb.csic.es/scipionbox/lastHTMLReport/">this</a>.</p>
</div>
<div class="section" id="launching-workflows">
<h2>Launching workflows<a class="headerlink" href="#launching-workflows" title="Permalink to this headline">¶</a></h2>
<p>Scipion can launch streaming workflows in several ways. The most basic one is
achieved creating an empty project to start a new workflow with an <em>Import Movies</em>
protocol pointing to the microscope’s deposition directory. Since we want to process
the movies that are currently located at that directory but, also, those movies
that are continuously arriving, we must activate the streaming mode in the streaming tab as
shown in the figure below. Afterwards, the rest of the protocols can be
added to the workflow in the same way that in the non streaming workflows,
but now all the protocols will wait for new data to process.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="docs/facilities/docs/images/streaming-tab.png"><img alt="streaming tab" src="docs/facilities/docs/images/streaming-tab.png" style="width: 900px;" /></a>
</div>
<p>Tthe two main parameters associated to the streaming mode are:</p>
<ul class="simple">
<li><strong>Timeout</strong>: The time to wait after not receiving new images to close the acquisition.</li>
<li><strong>File timeout</strong>: Scipion is checking if a new file is growing up. If it do not change after this time, Scipion will consider that it is ready to be imported.</li>
</ul>
<p>Usually the general <em>timeout</em> is a huge value (43,200 seconds = 12 hours) in
order to prevent ending the acquisition in an eventual acquisition issue at the microscope side.
Therefore, EM operator has this time to solve the issue.</p>
<p>When we know that the acquisition is finished, we can manually stop the processing
by selecting the <em>Import &gt; right-click &gt; STOP STREAMING</em>.</p>
<p>The procedure of creating manual workflows might be tedious for a facility,
where the same workflow will be usually employed for most users (or a small
number of different workflows).
For this reason, Scipion is able to automatically launch whole workflows by means of (at least)
3 ways:</p>
<ul class="simple">
<li>Launching static templates.</li>
<li>Launching dynamic templates.</li>
<li>Launching Python scripts using the Scipion’s API.</li>
</ul>
<div class="section" id="static-templates">
<h3>Static templates<a class="headerlink" href="#static-templates" title="Permalink to this headline">¶</a></h3>
<p>You can design a workflow by using Scipion as usual. Add an import, add some
processing protocols, add the summary monitor… When you are happy with your
workflow, you can export it by selecting all protocols that you want to export
(<em>ctrl+click</em> to select more than one) and, then, click the <em>Export</em> button at top.
You can save it as a template (a JSON file) at any directory on your system.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="docs/facilities/docs/images/export-and-exportUpload-button.png"><img alt="export workflows" src="docs/facilities/docs/images/export-and-exportUpload-button.png" style="width: 900px;" /></a>
</div>
<p>Additionally, Scipion has a public workflows repository at <a class="reference external" href="http://workflows.scipion.i2pc.es">http://workflows.scipion.i2pc.es</a>.
The workflows are classified in different categories, such as <strong>Data Collection</strong>,
2D classification, 3D classification, Model Building… If you click a certain
workflow, you can see a preview of that workflow at left side. Use the <em>mouse-wheel</em>
to zoom in/out, <em>click and drag</em> an empty zone to move and click on a box/protocol
to inspect the internal parameters. You can download a certain workflow to any
directory on you system. In addition, anyone can upload workflows (without any
log up) by selecting all the protocols in your Scipion’s project
and by clicking <em>Export &amp; Upload</em>.</p>
<p>In order to launch any template (downloaded or made by yourself), open Scipion
and create an empty project. Then, you can import the workflow in <em>Project &gt;
Import Workflow</em> and browsing to where the template is stored/downloaded
(Scipion’s templates are <em>JSON</em> files). As the template is opened, the workflow
is loaded to the project as <em>saved</em> protocols. At this point, you can check/modify
any parameter of a certain protocol by opening the protocol form by <em>right-click &gt; Edit</em>.
When you are happy with all the parameters, store the protocol by clicking <strong>Save</strong>
(do <strong>not</strong> click Execute/Schedule). When you are happy with all protocols,
select the <em>Import</em> protocol, <em>right-click &gt; Restart workflow</em>.
Then, the <em>Import</em> should start to import data and the rest of the protocols should
change to the <em>Schedule</em> mode. A scheduled protocol is waiting for ready
inputs. Therefore, when all inputs become ready for it, that protocol should
automatically start to process the incoming data.</p>
<p>Alternatively, a JSON template can be launched from the command line as follow</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion python pyworkflow/project/scripts/create.py <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;myAcquisition&quot;</span> <span class="nv">workflow</span><span class="o">=</span><span class="s2">&quot;path/to/your/workflow.json&quot;</span>
scipion python pyworkflow/project/scripts/schedule.py myAcquisition
scipion project myAcquisition
</pre></div>
</div>
<p>where the first command creates the project, the second starts the processing and
the third opens the Scipion GUI to see the project.</p>
</div>
<div class="section" id="dynamic-templates">
<h3>Dynamic templates<a class="headerlink" href="#dynamic-templates" title="Permalink to this headline">¶</a></h3>
<p>Usually, we always must set the same parameters that are specific of each acquisition
such as, deposition path, gain image path, dose per frame, particle size…
Then, in order to avoid manually editing this parameters using the procedure
explained for the static templates (previous section), Scipion has a mode to
open modified templates in such a way that an initial form is launched asking
for that specific parameters at once.</p>
<p>To see a demo of this you just have to run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion demo
</pre></div>
</div>
<p>This will pop up a small wizard like the one below ready to go.</p>
<div class="figure align-center">
<img alt="Cryo EM Streaming demo wizard" src="https://user-images.githubusercontent.com/785633/33311258-87304f44-d424-11e7-844a-8360708fa7ed.png" />
</div>
<p>You can fill the form according to your data or just leave all the displayed
fields untouched since it goes right with the test data. Once you click on the
<em>Start demo</em> button Scipion should appear with the new project loaded and running in
streaming mode.</p>
<p><em>Import movies</em> should already be importing files and the rest are scheduled. As soon as there
is any input available, the protocols will start processing it and making it
available for the next protocol in line. Also, the <em>Monitor summary</em> is
monitoring the progress and generating an HTML report with the outcome of the data.</p>
<p><strong>(*) Requirements for the demo</strong>:</p>
<p>To run the demo as it is, you need to have installed:</p>
<ul class="simple">
<li>scipion-em-motioncorr</li>
<li>scipion-em-grigoriefflab</li>
<li>scipion-em-eman</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion installp -p scipion-em-motioncorr -p scipion-em-grigoriefflab scipion-em-eman2
</pre></div>
</div>
<p><em>Notice that motioncor2 needs GPU acceleration.</em></p>
<p>In addition, the demo use either the jmbFalconMovies dataset for v1.2-Caligula
version or the relion13_tutorial dataset for later versions (also for devel branch).
Thus, you can download the dataset that you need by</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion testdata --download jmbFalconMovies relion13_tutorial
</pre></div>
</div>
<p><strong>Adding custom dynamic templates</strong></p>
<p>The dynamic template explained above is just an example, but you can create your
custom dynamic templates according with your preferences, the system requirements…
using static templates (explained in the previous section above) as a starting
points to create the dynamic ones. A Scipion’s template is a <em>JSON</em> file, which
are composed by a list of all the protocols in the workflow.
In the figure below, we have highlight the <em>Import movies</em> protocol with a blue
box, where are listed in all the internal parameters/fields for the import.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="docs/facilities/docs/images/custom-scipion-demo.png"><img alt="custom scipion demo" src="docs/facilities/docs/images/custom-scipion-demo.png" style="width: 900px;" /></a>
</div>
<p>In a common <em>JSON</em> file, all fields are made of key-value pairs where <em>key</em>
(what is before ‘:’) is always a <em>string</em> and the <em>value</em> (what is after ‘:’)
can be a <em>string</em> (“something coated”), a <em>number</em>, a
<em>Boolean</em> (true or false) or <em>null</em> (<a class="reference external" href="https://www.json.org">more info</a>).
Additionally, we have created a syntax to add dynamic fields to that <em>JSON</em> file. Then, to add a
dynamic field, you just have to substitute the value (what is after the ‘:’) of
a certain field for a string starting and ending by ‘~’, and with three strings
separated by ‘|’, something like</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;~label|defaultValue|typeValue~&quot;</span>
</pre></div>
</div>
<p>where <em>label</em> is the name of the filed in the form, <em>defaultValue</em> is the
default value inserted in the field and <em>typeValue</em> is a number fixing the type of the value
(0 for <em>strings</em>, 1 for <em>booleans</em>, 2 for <em>paths</em>, 3 for <em>integers</em>, and 4 for <em>floats</em>).</p>
<p>In the figure above, there are three examples for the <em>filesPath</em>, <em>dosePerFrame</em>
and <em>gainFile</em> fields. Notice that the type for the <em>filesPath</em> field is set to
2, which means <em>path</em>, then Scipion will check that this path exists before starting
to process. <em>gainFile</em> is set to 0 (<em>string</em>) to allow an empty value (to skip
using a gain image if not needed). Finally, the 4 (<em>float</em> type) set to the <em>dosPerFrame</em> allows to
introduce non integer values.</p>
<p>When you are happy with the modified <em>JSON</em> file, you must save it to</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SCIPION_HOME</span>/pyworkflow/templates
</pre></div>
</div>
<p>where <em>$SCIPION_HOME</em> is where you have installed Scipion. The extension of the
file must be <strong>.json.template</strong>.</p>
<p>When more than one dynamic template is in the <em>$SCIPION_HOME/pyworkflow/templates</em>
directory, then running</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion demo
</pre></div>
</div>
<p>opens a menu to choose the dynamic template to launch</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="docs/facilities/docs/images/multiple-choice-scipion-demo.png"><img alt="multiple choise scipion demo" src="docs/facilities/docs/images/multiple-choice-scipion-demo.png" style="width: 900px;" /></a>
</div>
</div>
<div class="section" id="using-scipion-s-api">
<h3>Using Scipion’s API<a class="headerlink" href="#using-scipion-s-api" title="Permalink to this headline">¶</a></h3>
<p>A Scipion’s project can be created, designed (adding protocols) and launched by
a Python script by using the <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.html">Scipion’s API</a>.</p>
<p>We have a repository destined to share Scipion’s code used in
<a class="reference external" href="https://github.com/I2PC/em-facilities">EM-facilities</a>.
Specially, we have an example of creating a Scipion’s project using the API
<a class="reference external" href="https://github.com/I2PC/em-facilities/blob/master/usingAPI_demo/acquisition_workflow.py">here</a>.
This code is loaded by the <cite>form_launcher.py</cite> at same directory and it can be
by</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion python <span class="nv">$EM_FACILITIES</span>/usingAPI_demo/form_launcher.py <span class="o">[</span>scipionbox.conf<span class="o">]</span>
</pre></div>
</div>
<p>where the optional <em>scipionbox.conf</em> parameter is a config file that will be read
in order to retrieve some configuration parameters. If not provided, a default
file in the same directory is used.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../api/pyworkflow.html" class="btn btn-neutral float-right" title="pyworkflow package" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="facilities-tutorial.html" class="btn btn-neutral float-left" title="Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-2.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="facilities.html">release-2.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>