

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating a monitor &mdash; Scipion 2.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../static/documentation_options.js"></script>
        <script type="text/javascript" src="../../static/jquery.js"></script>
        <script type="text/javascript" src="../../static/underscore.js"></script>
        <script type="text/javascript" src="../../static/doctools.js"></script>
        <script type="text/javascript" src="../../static/language_data.js"></script>
    
    <script type="text/javascript" src="../../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="pyworkflow package" href="../../api/pyworkflow.html" />
    <link rel="prev" title="Building Scipion docs" href="building-scipion-docs.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/install-from-sources.html">Installing from sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/host-configuration.html">Host configuration</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#graphical-interface-manuals">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="developers.html">General Information</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developers.html#extending-scipion">Extending Scipion</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="creating-a-plugin.html">Creating a plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="creating-a-protocol.html">Creating a protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="building-scipion-docs.html">Building Scipion docs</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Creating a monitor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-is-a-monitor">What is a monitor?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#monitors-anatomy">Monitors anatomy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#developing-a-disk-space-monitor">Developing a disk space monitor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#first-iteration">First iteration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nd-iteration-persist-the-values-in-a-txt-file">2nd iteration: persist the values in a txt file</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-monitor">Using the Monitor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#protocol-monitor">Protocol monitor</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#todo-customize-the-html-report">TODO: Customize the HTML report</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#todo-developing-output-viewers">TODO - Developing output Viewers</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#todo-integrating-parameter-wizards">TODO - Integrating parameter Wizards</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#todo-writing-tests-tests-and-more-tests">TODO - Writing Tests, Tests, and more Tests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="developers.html#development-tools">Development Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="developers.html#advanced-development-topics">Advanced Development Topics</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/pyworkflow.html">pyworkflow package</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="developers.html">General Information</a> &raquo;</li>
        
      <li>Creating a monitor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../sources/docs/developer/creating-a-monitor.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="creating-a-monitor">
<span id="id1"></span><h1>Creating a monitor<a class="headerlink" href="#creating-a-monitor" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-a-monitor">
<h2>What is a monitor?<a class="headerlink" href="#what-is-a-monitor" title="Permalink to this headline">¶</a></h2>
<p>A monitor is a non-GUI class which main action would be to do something,
periodically and notify any possible “listeners”.</p>
</div>
<div class="section" id="monitors-anatomy">
<h2>Monitors anatomy<a class="headerlink" href="#monitors-anatomy" title="Permalink to this headline">¶</a></h2>
<p>The base <code class="xref py py-class docutils literal notranslate"><span class="pre">monitor</span> <span class="pre">class</span></code> looks like this:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Monitor</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Where to store any data from this monitor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;workingDir&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samplingInterval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;samplingInterval&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitorTime</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;monitorTime&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_notifiers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;stdout&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PrintNotifier</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notifiers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">n</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; To be defined in subclasses. &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initLoop</span><span class="p">()</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">60.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitorTime</span>   <span class="c1"># interval minutes from now</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">finished</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="ow">or</span> <span class="n">finished</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samplingInterval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; To be defined in subclasses. &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">addNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notifier</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">notifier</span><span class="p">)</span>
</pre></div>
</div>
<p>The most important method of a monitor is</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; To be defined in subclasses. &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>In this base class it is not implemented, but if you want to develop a
monitor, you have to implement this method. The <strong>step()</strong> method will be
called from the <strong>loop()</strong> in a regular manner until a
<strong>self.monitorTime</strong> is reached or it is intentionally stopped.</p>
<p>Optionally, you can code an <strong>initLoop()</strong> method that will be called
before the loops start, suitable for some initializations.</p>
<p>Additionally, monitors follow an <a class="reference external" href="https://en.wikipedia.org/wiki/Observer_pattern">observer
pattern</a> where any
interested “listener/observer” could register and receive notifications
from the monitor.</p>
</div>
<div class="section" id="developing-a-disk-space-monitor">
<h2>Developing a disk space monitor<a class="headerlink" href="#developing-a-disk-space-monitor" title="Permalink to this headline">¶</a></h2>
<p>Let’s start coding something. Let’s create a python file in our tutorial
package and create there our new monitor class.</p>
<div class="section" id="first-iteration">
<h3>First iteration<a class="headerlink" href="#first-iteration" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Create a new folder called <code class="docutils literal notranslate"><span class="pre">myfacility</span></code>, and inside it, a folder called <code class="docutils literal notranslate"><span class="pre">protocols</span></code>.</li>
<li>Add a <code class="docutils literal notranslate"><span class="pre">space_monitor.py</span></code> file to <code class="docutils literal notranslate"><span class="pre">&lt;your-path&gt;/myfacility/protocols</span></code></li>
<li>Import <a class="reference internal" href="../../api/pyworkflow.em.protocol.monitors.protocol_monitor.html#pyworkflow.em.protocol.monitors.protocol_monitor.Monitor" title="pyworkflow.em.protocol.monitors.protocol_monitor.Monitor"><code class="xref py py-class docutils literal notranslate"><span class="pre">Monitor</span></code></a>
base class, and define your new class based on <code class="docutils literal notranslate"><span class="pre">Monitor</span></code></li>
</ol>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span>  <span class="nn">pyworkflow.em.protocol.monitors</span> <span class="k">import</span> <span class="n">Monitor</span>


<span class="k">class</span> <span class="nc">SpaceMonitor</span><span class="p">(</span><span class="n">Monitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monitor to monitor free space on the HD where scipion project is placed</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Implement the step method. This method should find the HD where the
project is placed.</li>
</ol>
<p>Import some modules at the top of the file (import section)</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">collections</span>
</pre></div>
</div>
<p>Add the following to the step method:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Using the workingdir attribute has to find the HD and then get the</span>
<span class="sd">        available free space.&quot;&quot;&quot;</span>

        <span class="n">usage</span> <span class="o">=</span> <span class="n">disk_usage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span>

<span class="c1"># Taken from http://code.activestate.com/recipes/577972-disk-usage/</span>
<span class="k">def</span> <span class="nf">disk_usage</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">_ntuple_diskusage</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;usage&#39;</span><span class="p">,</span> <span class="s1">&#39;total used free&#39;</span><span class="p">)</span>

    <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">statvfs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">free</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">f_bavail</span> <span class="o">*</span> <span class="n">st</span><span class="o">.</span><span class="n">f_frsize</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">f_blocks</span> <span class="o">*</span> <span class="n">st</span><span class="o">.</span><span class="n">f_frsize</span>
    <span class="n">used</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">f_blocks</span> <span class="o">-</span> <span class="n">st</span><span class="o">.</span><span class="n">f_bfree</span><span class="p">)</span> <span class="o">*</span> <span class="n">st</span><span class="o">.</span><span class="n">f_frsize</span>
    <span class="k">return</span> <span class="n">_ntuple_diskusage</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">used</span><span class="p">,</span> <span class="n">free</span><span class="p">)</span>
</pre></div>
</div>
<p>This is adding a new method <code class="docutils literal notranslate"><span class="pre">disk_usage</span></code> which receives a path and
uses it in the step method, printing it (temporarily).</p>
<ol class="arabic simple" start="5">
<li>Expose new monitor to the package: add
<code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">space_monitor</span> <span class="pre">import</span> <span class="pre">SpaceMonitor,</span> <span class="pre">ProtMonitorSpace</span></code> to  <code class="docutils literal notranslate"><span class="pre">&lt;your-path&gt;/myfacility/protocols/__init__.py</span></code></li>
</ol>
<div class="section" id="testing-first-iteration">
<h4>Testing first iteration<a class="headerlink" href="#testing-first-iteration" title="Permalink to this headline">¶</a></h4>
<p>We are going now to add some tests to check our progress.</p>
<ol class="arabic simple">
<li>Add a tests folder to the package (<code class="docutils literal notranslate"><span class="pre">&lt;your-path&gt;/myfacility/tests</span></code></li>
<li>Add an empty <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> to make it a module</li>
<li>Add <code class="docutils literal notranslate"><span class="pre">test_monitor.py</span></code> to the tests folder</li>
<li>Add the code below</li>
</ol>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pyworkflow.tests</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">myfacility.protocols</span> <span class="k">import</span> <span class="n">SpaceMonitor</span>

<span class="c1"># Test monitor functionality</span>
<span class="k">class</span> <span class="nc">TestMonitor</span><span class="p">(</span><span class="n">BaseTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Instantiate the monitor</span>
        <span class="n">spaceMonitor</span> <span class="o">=</span> <span class="n">SpaceMonitor</span><span class="p">(</span><span class="n">workingDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

        <span class="n">spaceMonitor</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li>Run the test:
<code class="docutils literal notranslate"><span class="pre">scipion</span> <span class="pre">test</span> <span class="pre">myfacility.tests.test_monitor.TestMonitor</span></code></li>
</ol>
<p>Output should look like this:</p>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Scipion</span>  <span class="p">(</span><span class="mi">2018</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>  <span class="p">((</span><span class="n">HEAD</span> <span class="n">detached</span> <span class="n">at</span> <span class="n">june_2018_course</span><span class="p">)</span> <span class="n">b9d0e37</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;&gt;&gt;</span> <span class="n">python</span>  <span class="n">scripts</span><span class="o">/</span><span class="n">run_tests</span><span class="o">.</span><span class="n">py</span> <span class="n">myfacility</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">test_monitor</span><span class="o">.</span><span class="n">TestMonitor</span>
<span class="n">Running</span> <span class="n">tests</span><span class="o">....</span>
<span class="n">usage</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">245527773184</span><span class="p">,</span> <span class="n">used</span><span class="o">=</span><span class="mi">127268225024</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="mi">105763827712</span><span class="p">)</span>
<span class="p">[</span> <span class="n">RUN</span>   <span class="n">OK</span> <span class="p">]</span> <span class="n">TestMonitor</span><span class="o">.</span><span class="n">test_monitor</span> <span class="p">(</span><span class="mf">0.001</span> <span class="n">secs</span><span class="p">)</span>

<span class="p">[</span><span class="o">==========</span><span class="p">]</span> <span class="n">run</span> <span class="mi">1</span> <span class="n">tests</span> <span class="p">(</span><span class="mf">0.001</span> <span class="n">secs</span><span class="p">)</span>
<span class="p">[</span>  <span class="n">PASSED</span>  <span class="p">]</span> <span class="mi">1</span> <span class="n">tests</span>
</pre></div>
</div>
<p>The disk stats are printed on the screen. This is not a proper test
since it will never fail and there are no checks (assertions) but soon we
will add them.</p>
</div>
</div>
<div class="section" id="nd-iteration-persist-the-values-in-a-txt-file">
<h3>2nd iteration: persist the values in a txt file<a class="headerlink" href="#nd-iteration-persist-the-values-in-a-txt-file" title="Permalink to this headline">¶</a></h3>
<p>We need to persist/store the values, and the easiest approach here is to
write the values in a text file.</p>
<div class="section" id="test-first">
<h4>Test first<a class="headerlink" href="#test-first" title="Permalink to this headline">¶</a></h4>
<p>Following a
<a class="reference external" href="https://en.wikipedia.org/wiki/Test-driven_development">TDD</a>
approach, we will first modify the test to expect the new behaviour.
Since we are going to generate files, let’s tell the monitor to use a
temporary folder instead of the <code class="docutils literal notranslate"><span class="pre">os.getcwd()</span></code>. For this we need to
first import at the top mkdtemp function from tempfile
<code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">tempfile</span> <span class="pre">import</span> <span class="pre">mkdtemp</span></code> and then use it when creating the
monitor in <code class="docutils literal notranslate"><span class="pre">myfacility/tests/test_monitor.py</span></code> file:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tempfile</span> <span class="k">import</span> <span class="n">mkdtemp</span>
<span class="p">[</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="p">]</span>
    <span class="k">def</span> <span class="nf">test_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Instantiate the monitor</span>
        <span class="n">spaceMonitor</span> <span class="o">=</span> <span class="n">SpaceMonitor</span><span class="p">(</span><span class="n">workingDir</span><span class="o">=</span><span class="n">mkdtemp</span><span class="p">())</span>

        <span class="n">spaceMonitor</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># Check storage file exists</span>
        <span class="n">fnStorageFile</span> <span class="o">=</span> <span class="n">spaceMonitor</span><span class="o">.</span><span class="n">getStorageFilePath</span><span class="p">()</span>

        <span class="c1"># Check that the file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fnStorageFile</span><span class="p">),</span>
                        <span class="s2">&quot;Storage file </span><span class="si">%s</span><span class="s2"> not created.&quot;</span> <span class="o">%</span> <span class="n">fnStorageFile</span><span class="p">)</span>

        <span class="c1"># Check there are 2 lines (headers and first data line)</span>
        <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">fnStorageFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>

        <span class="c1"># Assert lines are 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_lines</span><span class="p">,</span>
                         <span class="s2">&quot;First step of the monitor does not &quot;</span>
                         <span class="s2">&quot;have the expected lines: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Additionally, we have added some lines to:
* get the name of the storage file
* assert that it exists
* and test that it has 2 lines
* Since we haven’t modified our Monitor yet this test should fail</p>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>   <span class="n">FAILED</span> <span class="p">]</span> <span class="n">TestMonitor</span><span class="o">.</span><span class="n">test_monitor</span>

<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;/home/pablo/desarrollo/scipion/software/lib/python2.7/unittest/case.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">329</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run</span>
    <span class="n">testMethod</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">&quot;/home/pablo/desarrollo/scipion/pyworkflow/em/packages/myfacility/tests/test_monitor.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">16</span><span class="p">,</span> <span class="ow">in</span> <span class="n">test_monitor</span>
    <span class="n">fnStorageFile</span> <span class="o">=</span> <span class="n">spaceMonitor</span><span class="o">.</span><span class="n">getStorageFilePath</span><span class="p">()</span>
<span class="ne">AttributeError</span><span class="p">:</span> <span class="n">SpaceMonitor</span> <span class="n">instance</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s1">&#39;getStorageFilePath&#39;</span>

<span class="p">[</span><span class="o">==========</span><span class="p">]</span> <span class="n">run</span> <span class="mi">1</span> <span class="n">tests</span> <span class="p">(</span><span class="mf">0.003</span> <span class="n">secs</span><span class="p">)</span>
<span class="p">[</span>  <span class="n">FAILED</span>  <span class="p">]</span> <span class="mi">1</span> <span class="n">tests</span>
<span class="p">[</span>  <span class="n">PASSED</span>  <span class="p">]</span> <span class="mi">0</span> <span class="n">tests</span>
</pre></div>
</div>
<p>Our monitor does not have the <code class="docutils literal notranslate"><span class="pre">getStorageFilePath()</span></code> function.</p>
</div>
<div class="section" id="monitor-second">
<h4>Monitor second<a class="headerlink" href="#monitor-second" title="Permalink to this headline">¶</a></h4>
<p>Let’s implement what the test is expecting:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Using the workingdir attribute has to find the HD and then get the</span>
<span class="sd">    available free space.&quot;&quot;&quot;</span>

    <span class="n">usage</span> <span class="o">=</span> <span class="n">disk_usage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">storeUsageData</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getStorageFilePath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="p">,</span> <span class="s1">&#39;space_usage.txt&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">storeUsageData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usageData</span><span class="p">):</span>

    <span class="n">fnStorageFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStorageFilePath</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fnStorageFile</span><span class="p">):</span>
        <span class="n">fhStorage</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fnStorageFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">fhStorage</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;total</span><span class="se">\t</span><span class="s2">used</span><span class="se">\t</span><span class="s2">free</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fhStorage</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fnStorageFile</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>

    <span class="n">fhStorage</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">usageData</span><span class="o">.</span><span class="n">total</span><span class="p">,</span> <span class="n">usageData</span><span class="o">.</span><span class="n">used</span><span class="p">,</span> <span class="n">usageData</span><span class="o">.</span><span class="n">free</span><span class="p">))</span>

    <span class="n">fhStorage</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Note that we have:
1. Implemented the <code class="docutils literal notranslate"><span class="pre">getStorageFilePath()</span></code> method.
2. Implemented a <code class="docutils literal notranslate"><span class="pre">storeUsageData()</span></code> to store our usage data
3. In the <code class="docutils literal notranslate"><span class="pre">step()</span></code> function we have called the storage function:</p>
<blockquote>
<div><code class="docutils literal notranslate"><span class="pre">self.storeUsageData(usage)</span></code></div></blockquote>
</div>
</div>
</div>
<div class="section" id="using-the-monitor">
<h2>Using the Monitor<a class="headerlink" href="#using-the-monitor" title="Permalink to this headline">¶</a></h2>
<p>What we have done is just a piece of “behaviour” it will calculate the
statistics of the HD where a certain folder (workingFolder) belongs. But
how can we start it from a scipion project?</p>
<div class="section" id="protocol-monitor">
<h3>Protocol monitor<a class="headerlink" href="#protocol-monitor" title="Permalink to this headline">¶</a></h3>
<p>There is a special protocol (ProtMonitor) that is designed to have
monitors running. It can be found at
<a class="reference internal" href="../../api/pyworkflow.em.protocol.monitors.protocol_monitor.html#pyworkflow.em.protocol.monitors.protocol_monitor.ProtMonitor" title="pyworkflow.em.protocol.monitors.protocol_monitor.ProtMonitor"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyworkflow.em.protocol.monitors.protocol_monitor.ProtMonitor</span></code></a>. It inherits
from <code class="docutils literal notranslate"><span class="pre">EMProtocol</span></code> and defines several parameters:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">inputProtocols</span></code>: Protocols to be monitored</li>
<li><code class="docutils literal notranslate"><span class="pre">samplingInterval</span></code>: Monitoring time interval between samples</li>
<li><code class="docutils literal notranslate"><span class="pre">Mail</span> <span class="pre">params</span></code> (Optional): All email params needed to send emails</li>
</ul>
<p>Note that our case, monitoring the HD, does not require any specific
inputProtocol to monitor.</p>
<p>Additionally, this special protocol will create a “monitorStep” that any
“implementer” has to implement:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># -------------------------- INSERT steps functions -----------------------</span>
<span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;monitorStep&#39;</span><span class="p">)</span>

<span class="c1"># -------------------------- STEPS functions ------------------------------</span>
<span class="k">def</span> <span class="nf">monitorStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<div class="section" id="first-iteration-space-monitor-protocol">
<h4>First iteration: Space monitor protocol<a class="headerlink" href="#first-iteration-space-monitor-protocol" title="Permalink to this headline">¶</a></h4>
<p>Let’s define a new Class for our Space Monitor Protocol at <code class="docutils literal notranslate"><span class="pre">space_monitor.py</span></code>.
1. Import ProtMonitor and PrintNotifier at the top:
2. Import last version
3. Add our ProtMonitorSpace:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyworkflow.em</span> <span class="k">import</span> <span class="n">ProtMonitor</span><span class="p">,</span> <span class="n">PrintNotifier</span>
<span class="kn">from</span> <span class="nn">pyworkflow</span> <span class="k">import</span> <span class="n">VERSION_2_0</span>

<span class="k">class</span> <span class="nc">ProtMonitorSpace</span><span class="p">(</span><span class="n">ProtMonitor</span><span class="p">):</span>

    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;monitor of HD space&#39;</span>
    <span class="n">_lastUpdateVersion</span> <span class="o">=</span> <span class="n">VERSION_2_0</span>

    <span class="c1"># Overwrite the monitor step function</span>
    <span class="k">def</span> <span class="nf">monitorStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Instantiate a Space Monitor</span>
        <span class="n">monitor</span> <span class="o">=</span> <span class="n">SpaceMonitor</span><span class="p">(</span><span class="n">workingDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(),</span>
                               <span class="n">samplingInterval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">samplingInterval</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                               <span class="n">monitorTime</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="n">monitor</span><span class="o">.</span><span class="n">addNotifier</span><span class="p">(</span><span class="n">PrintNotifier</span><span class="p">())</span>
        <span class="n">monitor</span><span class="o">.</span><span class="n">loop</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Make our monitor to notify something, at the end of out
SpaceMonitor.step() add <code class="docutils literal notranslate"><span class="pre">self.notify(&quot;HD</span> <span class="pre">stats&quot;,</span> <span class="pre">str(usage))</span></code></li>
<li>Expose the new protocol to Scipion. In  <code class="docutils literal notranslate"><span class="pre">myfacility/protocols/__init__.py</span></code>
add:</li>
</ol>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span>from space_monitor import SpaceMonitor, ProtMonitorSpace``
</pre></div>
</div>
<p>Now Scipion should be able to discover it and you should be able to run
it:</p>
<div class="figure" id="id2">
<img alt="../../images/spaceprotdiscovered.png" src="../../images/spaceprotdiscovered.png" />
<p class="caption"><span class="caption-text">We can find our new monitor if we search using Ctrl-F</span></p>
</div>
<div class="figure" id="id3">
<img alt="../../images/runningspacemonitor.png" src="../../images/runningspacemonitor.png" />
<p class="caption"><span class="caption-text">And we can run it!</span></p>
</div>
<p>So far this is OK, but:</p>
<ul class="simple">
<li>The output is hardly readable….we should convert bytes into GB (at least) to be human-friendly</li>
<li>More important, there is only a Print notifier, so someone has to actively look at the logs.</li>
<li>A plot might be useful to plot the HD stats.</li>
</ul>
</div>
<div class="section" id="nd-iteration-space-monitor-protocol-tweaks">
<h4>2nd iteration: Space monitor protocol tweaks<a class="headerlink" href="#nd-iteration-space-monitor-protocol-tweaks" title="Permalink to this headline">¶</a></h4>
<div class="section" id="human-friendly-output">
<h5>Human-friendly output<a class="headerlink" href="#human-friendly-output" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li>Import <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">pyworkflow.utils</span> <span class="pre">import</span> <span class="pre">prettySize</span></code></li>
<li>In the step function of SpaceMonitor, just before calling notify, convert the
values and modify the notify call:</li>
</ol>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span>from pyworkflow.utils import prettySize

[ . . . ]

   self.storeUsageData(usage)

   # Stats line readable:
   free = prettySize(usage.free)
   total = prettySize(usage.total)
   used = prettySize(usage.used)

   self.notify(&quot;HD stats (%s)&quot; % self.workingDir,
               &quot;Free: %s, Total: %s, Used: %s&quot; % (free, total, used))```
</pre></div>
</div>
</div>
<div class="section" id="add-an-email-notifier-and-remove-the-inputprotocols">
<h5>Add an Email notifier… and remove the inputProtocols<a class="headerlink" href="#add-an-email-notifier-and-remove-the-inputprotocols" title="Permalink to this headline">¶</a></h5>
<p>Let’s tweak the parameters of the protocol:</p>
<p>Import params from em, like so:
<code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">pyworkflow.em</span> <span class="pre">import</span> <span class="pre">ProtMonitor,</span> <span class="pre">PrintNotifier,</span> <span class="pre">params</span></code></p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyworkflow.em</span> <span class="k">import</span> <span class="n">ProtMonitor</span><span class="p">,</span> <span class="n">PrintNotifier</span><span class="p">,</span> <span class="n">params</span>

<span class="p">[</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="p">]</span>

    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;monitor of HD space&#39;</span>
    <span class="n">_lastUpdateVersion</span> <span class="o">=</span> <span class="n">VERSION_2_0</span>

    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Overwrite the standard define params &quot;&quot;&quot;</span>

        <span class="c1"># This should define the inputProtocols and the sampling interval</span>
        <span class="n">ProtMonitor</span><span class="o">.</span><span class="n">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>

        <span class="c1"># Remove the inputProtocols</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getSection</span><span class="p">(</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>
        <span class="n">section</span><span class="o">.</span><span class="n">_paramList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;inputProtocols&#39;</span><span class="p">)</span>

        <span class="c1"># Add a threshold for the email notifier</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;minimumFreeSpace&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Minimum free space (GB)&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Notify by email or console when HD free space&quot;</span>
                           <span class="s2">&quot; drops below the minimum&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sendMailParams</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

    <span class="c1"># Overwrite the monitor step function</span>
    <span class="k">def</span> <span class="nf">monitorStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Instantiate a Space Monitor</span>
        <span class="n">monitor</span> <span class="o">=</span> <span class="n">SpaceMonitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minimumFreeSpace</span><span class="p">,</span>
                               <span class="n">workingDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(),</span>
                               <span class="n">samplingInterval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">samplingInterval</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                               <span class="n">monitorTime</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="n">monitor</span><span class="o">.</span><span class="n">addNotifier</span><span class="p">(</span><span class="n">PrintNotifier</span><span class="p">())</span>

        <span class="c1"># Create the email notifier</span>
        <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createEmailNotifier</span><span class="p">()</span>

        <span class="c1"># If email option active</span>
        <span class="k">if</span> <span class="n">email</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">monitor</span><span class="o">.</span><span class="n">addNotifier</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

        <span class="n">monitor</span><span class="o">.</span><span class="n">loop</span><span class="p">()</span>
</pre></div>
</div>
<p>We have added the <code class="docutils literal notranslate"><span class="pre">_defineParams(self,</span> <span class="pre">form)</span></code> method. There we have
called the <code class="docutils literal notranslate"><span class="pre">ProtMonitor._defineParams(self,</span> <span class="pre">form)</span></code> to have the default
parent params. Next thing is to delete the <code class="docutils literal notranslate"><span class="pre">inputProtocols</span></code>. This wasn’t
expected in our API, but python is flexible enough to make this happen:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove the inputProtocols</span>
<span class="n">section</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getSection</span><span class="p">(</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>
<span class="n">section</span><span class="o">.</span><span class="n">_paramList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;inputProtocols&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Next thing is to add a <code class="docutils literal notranslate"><span class="pre">minimumFreeSpace</span></code> parameter to serve as a
threshold to send email in case free space goes below that threshold.
We also add the email notifications parameters with
<code class="docutils literal notranslate"><span class="pre">self._sendMailParams(form)</span></code>.</p>
<p>Secondly, we have also made some changes in the <code class="docutils literal notranslate"><span class="pre">monitorStep()</span></code> method. We
are passing the <em>minimumFreeSpace</em> value to the SpaceMonitor:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instantiate a Space Monitor</span>
<span class="n">monitor</span> <span class="o">=</span> <span class="n">SpaceMonitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minimumFreeSpace</span><span class="p">,</span>
                       <span class="n">workingDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(),</span>
                       <span class="n">samplingInterval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">samplingInterval</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                       <span class="n">monitorTime</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>and finally, at the end we have requested for an EmailNotifier and added
it to the Monitor if condition apply. Our protocol looks ok, but our
monitor is not yet aware of the new parameter <code class="docutils literal notranslate"><span class="pre">'minimumFreeSpace'</span></code> and
is notifying in any loop.</p>
<ul>
<li><p class="first">Make SpaceMonitor to understand and react to ‘minimumFreeSpace’</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="k">class</span> <span class="nc">SpaceMonitor</span><span class="p">(</span><span class="n">Monitor</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Monitor to monitor free space on the HD where scipion project is placed</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimumFreeSpace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">Monitor</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">minimumFreeSpace</span> <span class="o">=</span> <span class="n">minimumFreeSpace</span>
</pre></div>
</div>
</li>
<li><p class="first">And modify the <code class="docutils literal notranslate"><span class="pre">step()</span></code> method of <code class="docutils literal notranslate"><span class="pre">SpaceMonitor</span></code> to take the threshold into account</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Using the workingdir attribute has to find the HD and then get the</span>
<span class="sd">    available free space.&quot;&quot;&quot;</span>

    <span class="n">usage</span> <span class="o">=</span> <span class="n">disk_usage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">storeUsageData</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span>

    <span class="c1"># Stats line readable:</span>
    <span class="n">free</span> <span class="o">=</span> <span class="n">prettySize</span><span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">free</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">prettySize</span><span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>
    <span class="n">used</span> <span class="o">=</span> <span class="n">prettySize</span><span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">used</span><span class="p">)</span>

    <span class="c1"># Free space in GB</span>
    <span class="n">freeGB</span> <span class="o">=</span> <span class="n">usage</span><span class="o">.</span><span class="n">free</span><span class="o">/</span><span class="p">(</span><span class="mf">1024.0</span><span class="o">**</span><span class="mf">3.0</span><span class="p">)</span>

    <span class="c1"># Notify only if free space is bellow the threshold in GB</span>
    <span class="k">if</span> <span class="n">freeGB</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimumFreeSpace</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="s2">&quot;WARNING: There is only </span><span class="si">%s</span><span class="s2"> left for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">free</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="p">),</span>
                    <span class="s2">&quot;Free: </span><span class="si">%s</span><span class="s2">, Total: </span><span class="si">%s</span><span class="s2">, Used: </span><span class="si">%s</span><span class="s2">, Threshold: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">free</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">used</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimumFreeSpace</span><span class="p">))</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="don-t-forget-the-test">
<h5>Don’t forget the test!!<a class="headerlink" href="#don-t-forget-the-test" title="Permalink to this headline">¶</a></h5>
<p>We haven’t touched the monitor test and more important, we are not
testing the protocol.</p>
<p>Our test should be failing because we are not passing the
<em>minimumFreeSpace</em>. Let’s do that:</p>
<ul class="simple">
<li>Update Monitor test: Replace (for simplicity) all content in <code class="docutils literal notranslate"><span class="pre">test_monitor.py</span></code> with:</li>
</ul>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">pyworkflow.tests</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">myfacility.protocols</span> <span class="k">import</span> <span class="n">SpaceMonitor</span><span class="p">,</span> <span class="n">ProtMonitorSpace</span>
<span class="kn">from</span> <span class="nn">myfacility.protocols.space_monitor</span> <span class="k">import</span> <span class="n">disk_usage</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="k">import</span> <span class="n">mkdtemp</span>

<span class="c1"># Test monitor functionality</span>
<span class="k">class</span> <span class="nc">TestMonitor</span><span class="p">(</span><span class="n">BaseTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Get a tmp folder</span>
        <span class="n">tmpFolder</span> <span class="o">=</span> <span class="n">mkdtemp</span><span class="p">()</span>

        <span class="c1"># Get freespace</span>
        <span class="n">diskUsage</span> <span class="o">=</span> <span class="n">disk_usage</span><span class="p">(</span><span class="n">tmpFolder</span><span class="p">)</span>
        <span class="n">freeSpaceInGB</span> <span class="o">=</span> <span class="n">diskUsage</span><span class="o">.</span><span class="n">free</span><span class="o">/</span><span class="p">(</span><span class="mf">1024.0</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Round it to the &quot;foor&quot;</span>
        <span class="n">freeSpaceInGB</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">freeSpaceInGB</span><span class="p">)</span>

        <span class="c1"># Instantiate the monitor</span>
        <span class="n">spaceMonitor</span> <span class="o">=</span> <span class="n">SpaceMonitor</span><span class="p">(</span><span class="n">freeSpaceInGB</span><span class="p">,</span> <span class="n">workingDir</span><span class="o">=</span><span class="n">tmpFolder</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">testNotifier</span> <span class="o">=</span> <span class="n">TestNotifier</span><span class="p">()</span>
        <span class="n">spaceMonitor</span><span class="o">.</span><span class="n">addNotifier</span><span class="p">(</span><span class="n">testNotifier</span><span class="p">)</span>

        <span class="n">spaceMonitor</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># Check storage file exists</span>
        <span class="n">fnStorageFile</span> <span class="o">=</span> <span class="n">spaceMonitor</span><span class="o">.</span><span class="n">getStorageFilePath</span><span class="p">()</span>

        <span class="c1"># Check that the file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fnStorageFile</span><span class="p">),</span>
                        <span class="s2">&quot;Storage file </span><span class="si">%s</span><span class="s2"> not created.&quot;</span> <span class="o">%</span> <span class="n">fnStorageFile</span><span class="p">)</span>

        <span class="c1"># Check there are 2 lines (headers and first data line)</span>
        <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">fnStorageFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>

        <span class="c1"># Assert lines are 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_lines</span><span class="p">,</span>
                         <span class="s2">&quot;First step of the monitor does not &quot;</span>
                         <span class="s2">&quot;have the expected lines: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Check notifications are empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">testNotifier</span><span class="o">.</span><span class="n">getNotifications</span><span class="p">()),</span> <span class="s2">&quot;Notifiactions are not empty!&quot;</span><span class="p">)</span>

        <span class="c1"># Move the threshold to trigger notifications</span>
        <span class="n">spaceMonitor</span><span class="o">.</span><span class="n">minimumFreeSpace</span> <span class="o">=</span> <span class="n">freeSpaceInGB</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">spaceMonitor</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># Check there is a notification</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">testNotifier</span><span class="o">.</span><span class="n">getNotifications</span><span class="p">()),</span> <span class="s2">&quot;There isn&#39;t a notifiaction&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TestNotifier</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notifications</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">def</span> <span class="nf">getNotifications</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notifications</span>

    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="c1"># Just store the message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>We have used the <code class="docutils literal notranslate"><span class="pre">diskUsage()</span></code> method to get the free space of the HD
of the <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> folder. We round it “down” and use that as the threshold for
the SpaceMonitor. Afte the first step there should not be any
notification. After the first assertions, we add another to check there
are no notifications. Secondly, we increase the threshold by one and
call for a second time <code class="docutils literal notranslate"><span class="pre">step()</span></code>. This time, there should be a
notification.</p>
<p>Note that we have to make our own <code class="docutils literal notranslate"><span class="pre">TestNotifier</span></code> in order to check the
notifications. Something we should provide, but wasn’t available in
Scipion today.</p>
<div class="section" id="add-a-test-for-the-protocol-monitor">
<h6>Add a test for the protocol monitor.<a class="headerlink" href="#add-a-test-for-the-protocol-monitor" title="Permalink to this headline">¶</a></h6>
<p>We also have to test the protocol. You will need to import
ProtMonitorSpace and a wait() function:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">pyworkflow.tests</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">myfacility.protocols</span> <span class="k">import</span> <span class="n">SpaceMonitor</span><span class="p">,</span> <span class="n">ProtMonitorSpace</span>
<span class="kn">from</span> <span class="nn">myfacility.protocols.space_monitor</span> <span class="k">import</span> <span class="n">disk_usage</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="k">import</span> <span class="n">mkdtemp</span>
</pre></div>
</div>
<p>Now add the code below right after
<code class="docutils literal notranslate"><span class="pre">self.assertEqual(1,</span> <span class="pre">len(testNotifier.getNotifications()),</span> <span class="pre">&quot;There</span> <span class="pre">isn't</span> <span class="pre">a</span> <span class="pre">notification&quot;)</span></code>
and right above our custom <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">TestNotifier</span></code></p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">setupTestProject</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_spacemonitor_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">prot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newProtocol</span><span class="p">(</span><span class="n">ProtMonitorSpace</span><span class="p">,</span>
                            <span class="n">objLabel</span><span class="o">=</span><span class="s1">&#39;HD free Space monitor&#39;</span><span class="p">,</span>
                            <span class="n">samplingInterval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">launchProtocol</span><span class="p">(</span><span class="n">prot</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Test that the spaceMonitor txt file is where expected</span>
    <span class="n">spaceMon</span> <span class="o">=</span> <span class="n">SpaceMonitor</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">workingDir</span><span class="o">=</span><span class="n">prot</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">())</span>
    <span class="n">txtPath</span> <span class="o">=</span> <span class="n">spaceMon</span><span class="o">.</span><span class="n">getStorageFilePath</span><span class="p">()</span>

    <span class="c1"># Wait for a minute maximun or if file exists</span>
    <span class="n">wait</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">txtPath</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">txtPath</span><span class="p">),</span> <span class="s2">&quot;Space monitor txt file not &quot;</span>
                                             <span class="s2">&quot;found at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">txtPath</span><span class="p">)</span>

    <span class="c1"># Stop the protocol. Do not wait for its timeout</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">stopProtocol</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span>
</pre></div>
</div>
<p>With the <code class="docutils literal notranslate"><span class="pre">setUpClass()</span></code> we are creating an empty Scipion project</p>
<p>Run the test:
<code class="docutils literal notranslate"><span class="pre">scipion</span> <span class="pre">test</span> <span class="pre">myfacility.tests.test_monitor.TestMonitor</span></code>.
In the <code class="docutils literal notranslate"><span class="pre">test_spacemonitor_protocol</span></code> we are creating one
<code class="docutils literal notranslate"><span class="pre">ProtMonitorSpace</span></code> and launching it. Since we want to test the
existence of txt file, we make use of a temporary SpaceMonitor to get
the exact txt file at the extra folder of our protocol. We must give
some time to the monitor (15 secs) before checking the file existence,
thus <code class="docutils literal notranslate"><span class="pre">wait(lambda:</span> <span class="pre">not</span> <span class="pre">os.path.exists(txtPath),</span> <span class="pre">timeout=15)</span></code>. Then, we
make the assertion and stop the protocol…since the only stop mechanism
it has is the default timeout (100 minutes).</p>
<p>You should get something like:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>➜  ~ scipion test myfacility.tests.test_monitor.TestMonitor

Scipion v2.0 (2019-03-15) Diocletian (release-2.0.0 584fbfa)

&gt;&gt;&gt;&gt;&gt; python  /home/yaiza/git/scipion/pyworkflow/apps/pw_run_tests.py &quot;myfacility.tests.test_monitor.TestMonitor&quot;
Running tests....
WARNING: There is only 185.82 GB left for /tmp/tmpXyZqpL Free: 185.82 GB, Total: 217.91 GB, Used: 21.00 GB, Threshold: 186.0
[ RUN   OK ] TestMonitor.test_monitor (0.061 secs)

[==========] run 1 tests (0.061 secs)
[  PASSED  ] 1 tests
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../api/pyworkflow.html" class="btn btn-neutral float-right" title="pyworkflow package" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="building-scipion-docs.html" class="btn btn-neutral float-left" title="Building Scipion docs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-2.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../release-2.0.0/docs/developer/creating-a-monitor.html">release-2.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>